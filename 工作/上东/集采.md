# 集采.md
[toc]



## 一 集采业务


## 二 集采系统
### 开团
* 一个主规格只能属于一种副规格，一种副规格可以配多个主规格
* 固定、范围、自定义副规格中的计算类型、计算参数属性影响的是下单时的商品单价。比如说：

![image](LkBuYKZSQ9cxp4OM0YHwzq0JOZT1EhVzchpwDgtwsL8.png)

意思是下单时该商品该副规格的单价+50

## 三 集采代码






/tuan/sys/dict/getDictItems接口：

买家下单时：https://buy.test.upeast.com.cn/tuan/sys/dict/getDictItems/business\_group,core\_org\_name,core\_org\_id,A

企业管理-仓库匹配-编辑：

https://buy.test.upeast.com.cn/tuan/sys/dict/getDictItems/t\_price\_catalog,name,id,org\_id:orgid63b36e45e084413c80a9501e883f5a58

---
查TQiyeCkgx，记得加（指派状态）zpzt=1

```java
QueryWrapper<TQiyeCkgx> wrapper = new QueryWrapper<TQiyeCkgx>();
wrapper.eq("ck", repoId);
wrapper.eq("seller", sellerId);
wrapper.eq("zpzt", "1");
```
---
集采仓库属于具体**分支机构**，在下单时会根据当前账号的分支机构去过滤仓库。

---
临时修改订单签署人手机号：

SELECT \* FROM cust\_tsign\_info WHERE lx='tuan' and customer\_id = 企业



---
集采文件上传：

[https://buyapi.test.upeast.com.cn/tuan/sys/common/upload](https://buyapi.test.upeast.com.cn/tuan/sys/common/upload)

参数：

biz（默认值temp）目录

file

---
集采文件下载：

[https://buyapi.test.upeast.com.cn/tuan/sys/common/static/](https://buyapi.test.upeast.com.cn/tuan/sys/common/static/)

后面拼oss文件路径

---
集采导出某省的供应商的仓库

```sql
select o.`org_id`, o.`org_name`, o.`province`, repo.`name`, repo.`area`, repo.`detail`
from zhzx.`org_base` o 
inner join `t_qiye` qiye ON o.`org_id` = qiye.`org_id` 
inner join `t_repository` repo ON o.`org_id` = repo.`org_id`
where (qiye.`ptsf` = 'buyer' or qiye.`ptsf` = 'all') and o.`province` in ('420000', '430000', '210000', '220000', '230000')
order by repo.`area`, o.`org_id`;
```
---
t\_board\_price中的catalog\_id是t\_tuan\_price\_catalog的id

t\_rule\_assign\_member 团购-团员采购价指定规则表 特定

t\_rule\_member\_price 团购-团员采购价指定规则表

t\_specs\_sub、t\_specs\_sub\_detail中的\_ids字段都是t\_specs的product\_no

---
[https://memberapi.test.upeast.com.cn/zhzx/api/eqbChange 测试环境这接口改了一下，支持修改e签手机号、企业名称、签章图片，同步修改e签宝的数据和本地数据，集采和金融的都一起修改了。 测试时候如果改了本地机构名字，用这个接口把e签包的签章图片更新一下保存到本地oss](https://memberapi.test.upeast.com.cn/zhzx/api/eqbChange 测试环境这接口改了一下，支持修改e签手机号、企业名称、签章图片，同步修改e签宝的数据和本地数据，集采和金融的都一起修改了。 测试时候如果改了本地机构名字，用这个接口把e签包的签章图片更新一下保存到本地oss)



---
* 涉及单价的地方，需要显示为保留四位小数
* 涉及其他金额的地方，需要保留两位小数

单价是4位小数，算总价时，每条的总价格先四舍五入，然后再把四舍五入后的金额加总。



---
[https://e7jw68xwqg.feishu.cn/sheets/E757sW4HshEE0YtkyWVcbJ4UnDf?sheet=odutvc](https://e7jw68xwqg.feishu.cn/sheets/E757sW4HshEE0YtkyWVcbJ4UnDf?sheet=odutvc) jicai-api 依赖的base包



---
集采加菜单：

1. 集采 /getUserPermissionByToken 接口根据买\\卖家添加url过滤，控制集采的菜单
2. 账户中心 /sys/role/queryTreeList 接口根据买\\卖家添加url过滤，控制角色管理中配置权限时展示的权限树
3. 使用SQL更新角色权限

```sql
insert into sys_role_permission (id, role_id, permission_id, operate_date)
select md5(uuid()), r.id, '1593812015346880514', now() from sys_role r join jicai.t_qiye q on q.id = r.orgid where q.ptsf = 'seller' or q.ptsf = 'all'
```
账户中心同理



---
集采缓存key：

在JicaiCacheKeys类中



---
测试环境，获知支付验证码临时解决办法：

访问 https://pdcenter.lianlianpay.com/tool/getSmsCodeTool.htm

填入手机号： 

13552114882  （上东芯链制品厂）

15600200988 （北京包装厂）

---
t_order_statement表的actual_buyer_id、actual_seller_id字段总是真实的买家、卖家，当结算单类型为退款、多退，buyer_id、buyer_name是付款人（也就是真实卖家）。


---
t_order_statement 表payable_amount字段为应付金额，先付全款、款到发货订单收货时生成的结算单的该字段为0。

---
先付全款 必须签子订单完成协议，无法自动关闭订单（但是现在没有这种场景）

货到付款 到期自动关闭订单

款到发货 需满足条件 可到期自动关闭订单

---
![[工作/上东/attachments/f4f1fbe2efac4a490fb55559ec4da386.png]]
款到发货：是指卖方在发货之前，与买家协商本次发货数量及价格（可调价），双方达成一致意见后，卖家录入核价单，买家支付货款之后，卖家再安排发货的一种交易模式。卖家安排货物出库后，依据核价单补录物流及货物信息，由买家确认收货。若买卖双方按照已支付的核价单完成履约及确认，订单到期自动关闭，否则运营介入核实履约情况，并协调处理。